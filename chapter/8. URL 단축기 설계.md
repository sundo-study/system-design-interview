# 1단계 - 문제 이해 및 설계 범위 확정

- 쓰기 연산: 매일 1억개의 단축 URL 생성
    - 초당 쓰기 연산: `1억/24/3600 = 1160`
    - 읽기 연산 : 초당 11,600회 발생
- URL 단축 서비스 10년간 운영 가정: `1억 * 365 * 10 = 3650억` 개의 레코드를 보관
- 축약 전 URL 평균 길이 100 byte
    - 즉, 10년 동안 필요한 저장 용량은 `3650억 * 100바이트 = 36.5TB`

# 2단계 - 개략적 설계안 제시 및 동의 구하기

## API 엔드포인트

URL 단축기는 기본적으로 2개의 엔드포인트를 필요로 한다.

1. URL 단축용 엔드포인트 
  - 새 단축 URL을 생성하고자 할 때, 단축할 URL을 인자로 넣어 POST 요청
2. URL 리다이렉션 엔드포인트
  - 단축 URL에 대해 HTTP 요청이 오면 원래의 URL로 보내주기 위해 리다이렉션 URL 반환

## URL redirection

HTTP에서 Redirection에 관한 status, header를 제공한다.

클라 - 단축 URL 방문 → 서버

클라 ← 상태코드 301 & 원래 URL - 서버

클라 - 원래 URL 방문  → 서버

### **301 Moved Permanently**

- 해당 URL에 대한 HTTP 요청의 처리 책임이 **영구적으로** Location 헤더에 반환된 URL로 이전되었다는 응답
- 영구적으로 이전 되었음으로 브라우저에서는 이 응답을 캐시한다. 즉, 단축 URL로의 request를 받았을 때 캐시된 데이터가 있다면, 브라우저는 원래 URL로 요청을 보내게 된다.
- 단축 URL 서버 부하를 줄이고 싶은 경우, 301을 사용하는 것이 좋을 수 있다.

### **302 Found**

- 요청한 리소스가 Location 헤더에 주어진 URL에 **일시적으로** 이동되었음을 가리킨다.
- 일시적으로 이전 됬음을 나타내므로 캐시되지 않는다. 즉, 단축 URL로의 request는 언제나 단축 URL 서버로 보내진 뒤 원래 URL로 redirection 될 것이다.
- 트래픽 분석 등 단축 URL 서버에서 모든 요청을 받아보는 것이 유의미한 경우, 302를 사용하는 것이 좋을 수 있다.

URL redirection을 구현하는 직관적인 방법은 해시 테이블을 사용하는 것이다.

- 원래 URL = hashTable.get(단축 URL)
    - 301 또는 302 응답 Location 헤더에 원래 URL을 넣은 후 전송
    

## URL 단축

- 중요한 것은 긴 URL 을 이 해시 값으로 대응시킬 해시 함수를 찾는 것

요구사항

- URL이 다르면, 당연히 해시 값도 달라야 한다.
- 해시 값은 원래의 URL로 복원될 수 있어야 한다.

# 3단계 - 상세 설계

## 데이터 모델

개략적 설계 때는 원래 URL, 단축 URL을 해시 테이블에 구성

- 양 많아지면 메모리는 유한하고 비싸기 때문에 무리→ RDB에 저장

## 해시 함수

### 해시 값 길이

[0-9, a-z, A-Z]로  구성 → 62개 

hashValue(단축 URL)의 길이는 몇으로 정할까?

- hashValue의 길이를 정하기 위해서는 `62^n >= 3650억` 에서의 n의 최소값을 찾아야 한다.
- n이 7이면 3.5조개의 URL 만들 수 있음 → hashValue의 길이를 7로 결정

1. 해시 후 충돌 해소 - `CRC32`, `MD5`, `SHA-1`
- 7글자보다 길다 → 앞 7개만 사용하자 → 충돌난다. → 충돌해결하기 위해 원래의 URL 에 추가해서 다시 해시함수 → 충돌 나지 않을 때까지 반복
- 충돌 여부 확인하기 위해 무조건 쿼리 날려야 함 → 오버헤드 발생
- 블룸필터 를 사용 -

2. base-62 사용

hashValue에 사용할 수 있는 문자가 62개이기 때문에 62진법 사용

- 0-9 → 0-9 / 10-35 → a-z / 36-61 → A-Z

- 유일성 보장 ID 생성기가 필요.

유일성 보장 ID를 단순히 전환하는 것이기에 충돌날 염려는 없다. 하지만, ID가 1씩 증가해 다음 단축 URL이 예측이 되는 보안적인 문제가 발생할 수 있고, 유일성 보장 ID가 길어짐과 비례해서 단축 URL 길이가 길어진다.

## URL 단축키 상세 설계 (base-62 사용)

1. 원래의 URL 입력
2. DB에 원래의 URL이 존재하는가 확인 
3. 없다면, 새로운 ID를 생성 (이 ID를 디비의 기본키로 사용)
4. 생성된 ID를 62진법 변환 기법을 적용해서 단축 URL로 변환
5. ID, 원래의 URL, 단축 URL을 DB에 저장 및 반환

# 4단계 - 마무리

더 논의해보면 좋을 내용

- 처리율 제한 장치의 사용
    - 엄청난 양의 단축 요청으로 무력화될 수 있음
    - IP 주소 등을 통해 필터링해서 앞단에서 요청을 걸러내자.
- 웹 서버/데이터베이스 규모확장
    - 웹 서버: 스케일 아웃
    - 데이터베이스: 다중화 또는 샤딩
- 데이터 분석 솔루션 사용
    - 302 → URL 단축 서버로 요청을 받을 수 있음
    - 어떤 링크를 얼마나 많은 사용자가 선택했는지? 언제 주로 클릭했는지? 등 확인 가능
